(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))s(c);new MutationObserver(c=>{for(const l of c)if(l.type==="childList")for(const i of l.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function a(c){const l={};return c.integrity&&(l.integrity=c.integrity),c.referrerPolicy&&(l.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?l.credentials="include":c.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(c){if(c.ep)return;c.ep=!0;const l=a(c);fetch(c.href,l)}})();const r={form:document.getElementById("prompt-form"),allTextareas:document.querySelectorAll("textarea"),promptParts:document.querySelectorAll(".prompt-part"),savableFields:document.querySelectorAll(".savable-field"),positiveOutput:document.getElementById("output-positive"),negativeOutput:document.getElementById("output-negative"),rebuildBtn:document.getElementById("rebuild-prompt"),presetNameInput:document.getElementById("preset-name"),presetSelect:document.getElementById("preset-select"),savePresetBtn:document.getElementById("save-preset-btn"),deletePresetBtn:document.getElementById("delete-preset-btn"),presetPreview:document.getElementById("preset-preview"),showManualBtn:document.getElementById("show-manual-btn"),manualModal:document.getElementById("manual-modal"),closeManualBtn:document.getElementById("close-manual-btn"),manualBody:document.querySelector(".manual-body"),langToggleCheckbox:document.getElementById("lang-toggle-checkbox"),themeToggleCheckbox:document.getElementById("theme-toggle-checkbox"),importPresetsBtn:document.getElementById("import-presets-btn"),exportPresetsBtn:document.getElementById("export-presets-btn"),appTitle:document.getElementById("app-title"),copyPositiveBtn:document.getElementById("copy-positive"),copyNegativeBtn:document.getElementById("copy-negative"),clearFormBtn:document.getElementById("clear-form-btn"),tagBrowserModal:document.getElementById("tag-browser-modal"),closeTagBrowserBtn:document.getElementById("close-tag-browser-btn"),tagBrowserTitle:document.getElementById("tag-browser-title"),tagBrowserSubcategories:document.getElementById("tag-browser-subcategories"),tagBrowserSearch:document.getElementById("tag-browser-search"),tagBrowserSelectionPreview:document.getElementById("tag-browser-selection-preview"),addSelectedTagsBtn:document.getElementById("add-selected-tags-btn"),resetSelectedTagsBtn:document.getElementById("reset-selected-tags-btn"),historyList:document.getElementById("history-list")},p={APP_VERSION:"1.0.0",LANG_KEY:"promptArtisanLang_v1",THEME_KEY:"promptArtisanTheme_v1",POSITIVE_QUALITY_TAGS:["masterpiece","best quality","highres","ultra-detailed"],NEGATIVE_QUALITY_TAGS:["worst quality","low quality","normal quality"],DEFAULT_NEGATIVE_PROMPT:"lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, jpeg artifacts, signature, watermark, username, blurry, artist name, bad feet, deformed, disfigured"},u={ru:{appTitle:"Prompt Artisan",helpTitle:"–ü–æ–º–æ—â—å",styleSection:"üé® –°—Ç–∏–ª—å –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è",stylePlaceholder:"–ù–∞–ø—Ä–∏–º–µ—Ä: photograph, oil painting, anime style...",styleTooltip:"–û–ø–∏—à–∏—Ç–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –≤–∏–¥ —Ä–∞–±–æ—Ç—ã. –≠—Ç–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è (photograph), –∫–∞—Ä—Ç–∏–Ω–∞ –º–∞—Å–ª–æ–º (oil painting), –∞–Ω–∏–º–µ (anime style) –∏–ª–∏ —á—Ç–æ-—Ç–æ –µ—â–µ?",subjectSection:"üë§ –°—É–±—ä–µ–∫—Ç –∏ –ü–µ—Ä—Å–æ–Ω–∞–∂",subjectActionHeader:"–û—Å–Ω–æ–≤–∞ –∏ –î–µ–π—Å—Ç–≤–∏–µ",subjectActionPlaceholder:"–ù–∞–ø—Ä–∏–º–µ—Ä: a knight riding a horse, 2 cats playing...",subjectActionTooltip:"–ö—Ç–æ –∏–ª–∏ —á—Ç–æ –≥–ª–∞–≤–Ω–æ–µ –≤ —Å—Ü–µ–Ω–µ –∏ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç? –ù–∞–ø—Ä–∏–º–µ—Ä: a wizard casting a spell –∏–ª–∏ a lonely robot sitting on a cliff.",appearanceHeader:"–í–Ω–µ—à–Ω–æ—Å—Ç—å –∏ –î–µ—Ç–∞–ª–∏",appearancePlaceholder:"–ù–∞–ø—Ä–∏–º–µ—Ä: long wavy red hair, intricate tattoos...",appearanceTooltip:"–û–ø–∏—à–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —á–µ—Ä—Ç—ã –≥–ª–∞–≤–Ω–æ–≥–æ —Å—É–±—ä–µ–∫—Ç–∞: green eyes, short messy hair, battle scars.",clothingHeader:"–û–¥–µ–∂–¥–∞ –∏ –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ",clothingPlaceholder:"–ù–∞–ø—Ä–∏–º–µ—Ä: wearing heavy armor, elegant silk dress...",clothingTooltip:"–í–æ —á—Ç–æ –æ–¥–µ—Ç —Å—É–±—ä–µ–∫—Ç –∏ —á—Ç–æ –¥–µ—Ä–∂–∏—Ç –≤ —Ä—É–∫–∞—Ö? –ë—É–¥—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã –≤ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö –∏ —Ç–∏–ø–∞—Ö.",sceneSection:"üèûÔ∏è –°—Ü–µ–Ω–∞ –∏ –ö–æ–º–ø–æ–∑–∏—Ü–∏—è",locationHeader:"–õ–æ–∫–∞—Ü–∏—è –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ",locationPlaceholder:"–ù–∞–ø—Ä–∏–º–µ—Ä: enchanted forest at night, on a spaceship bridge...",locationTooltip:"–ì–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–µ? –î–æ–±–∞–≤—å—Ç–µ –¥–µ—Ç–∞–ª–∏, —Ç–∞–∫–∏–µ –∫–∞–∫ –ø–æ–≥–æ–¥–∞ –∏ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫.",lightingHeader:"–û—Å–≤–µ—â–µ–Ω–∏–µ –∏ –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞",lightingPlaceholder:"–ù–∞–ø—Ä–∏–º–µ—Ä: cinematic lighting, moody, neon glow...",lightingTooltip:"–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º —Å –ø–æ–º–æ—â—å—é —Å–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: cinematic lighting –¥–ª—è –¥—Ä–∞–º—ã, golden hour –¥–ª—è —Ç–µ–ø–ª–∞ –∏–ª–∏ neon glow –¥–ª—è –∫–∏–±–µ—Ä–ø–∞–Ω–∫–∞.",cameraHeader:"–ö–∞–º–µ—Ä–∞ –∏ –†–∞–∫—É—Ä—Å",cameraPlaceholder:"–ù–∞–ø—Ä–∏–º–µ—Ä: full body shot, from below, close-up...",cameraTooltip:"–° –∫–∞–∫–æ–π —Ç–æ—á–∫–∏ –º—ã —Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Å—Ü–µ–Ω—É? –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: full body shot (–≤ –ø–æ–ª–Ω—ã–π —Ä–æ—Å—Ç), close-up (–∫—Ä—É–ø–Ω—ã–π –ø–ª–∞–Ω), from below (–≤–∏–¥ —Å–Ω–∏–∑—É).",finalPromptHeader:"–ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",copyBtn:"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",rebuildBtn:"–ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å",clearBtn:"–û—á–∏—Å—Ç–∏—Ç—å",presetsHeader:"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü—Ä–µ—Å–µ—Ç–∞–º–∏",importBtn:"–ò–º–ø–æ—Ä—Ç",exportBtn:"–≠–∫—Å–ø–æ—Ä—Ç",presetNamePlaceholder:"–ò–º—è –Ω–æ–≤–æ–≥–æ –ø—Ä–µ—Å–µ—Ç–∞",savePresetBtn:"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",presetSelectDefault:"--- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç ---",presetPreviewPlaceholder:"–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞",deletePresetBtn:"–£–¥–∞–ª–∏—Ç—å",footerText:"¬© 2025 Created by grvelvet",closeBtnTitle:"–ó–∞–∫—Ä—ã—Ç—å",copiedAlert:"–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!",alertNoPresets:"–ù–µ—Ç –ø—Ä–µ—Å–µ—Ç–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.",alertImportError:"–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON.",rebuildBtnTitle:"–°–±—Ä–æ—Å–∏—Ç—å —Ä—É—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç –∑–∞–Ω–æ–≤–æ",tagBrowserSearchPlaceholder:"–ü–æ–∏—Å–∫...",addSelectedBtn:"–î–æ–±–∞–≤–∏—Ç—å",resetSelectionBtn:"–°–±—Ä–æ—Å–∏—Ç—å",tagBrowserLoading:"–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤–∞—Ä—è...",tagBrowserError:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞—Ä—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø–∞–ø–∫–µ /data.",historyHeader:"–ò—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π",historyPlaceholder:"–ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤."},en:{appTitle:"Prompt Artisan",helpTitle:"Help",styleSection:"üé® Image Style",stylePlaceholder:"E.g., photograph, oil painting, anime style...",styleTooltip:"Describe the final look. Is it a photograph, an oil painting, an anime style, or something else?",subjectSection:"üë§ Subject & Character",subjectActionHeader:"Core & Action",subjectActionPlaceholder:"E.g., a knight riding a horse, 2 cats playing...",subjectActionTooltip:"Who or what is the main focus, and what is happening? E.g., a wizard casting a spell or a lonely robot sitting on a cliff.",appearanceHeader:"Appearance & Details",appearancePlaceholder:"E.g., long wavy red hair, intricate tattoos...",appearanceTooltip:"Describe the key features of the main subject: green eyes, short messy hair, battle scars.",clothingHeader:"Clothing & Gear",clothingPlaceholder:"E.g., wearing heavy armor, elegant silk dress...",clothingTooltip:"What is the subject wearing and holding? Be specific with materials and types.",sceneSection:"üèûÔ∏è Scene & Composition",locationHeader:"Location & Environment",locationPlaceholder:"E.g., enchanted forest at night, on a spaceship bridge...",locationTooltip:"Where is the action taking place? Add details like weather and time of day.",lightingHeader:"Lighting & Atmosphere",lightingPlaceholder:"E.g., cinematic lighting, moody, neon glow...",lightingTooltip:"Control the mood with light. Try: cinematic lighting for drama, golden hour for warmth, or neon glow for cyberpunk.",cameraHeader:"Camera & Angle",cameraPlaceholder:"E.g., full body shot, from below, close-up...",cameraTooltip:"From what point of view are we seeing the scene? Use: full body shot, close-up, from below.",finalPromptHeader:"Final Prompt & Controls",copyBtn:"Copy",rebuildBtn:"Rebuild",clearBtn:"Clear",presetsHeader:"Preset Management",importBtn:"Import",exportBtn:"Export",presetNamePlaceholder:"New preset name",savePresetBtn:"Save",presetSelectDefault:"--- Select a preset ---",presetPreviewPlaceholder:"Select a preset to preview",deletePresetBtn:"Delete",footerText:"¬© 2025 Created by grvelvet",closeBtnTitle:"Close",copiedAlert:"Copied!",alertNoPresets:"No presets to export.",alertImportError:"Error: Could not read the file. Ensure it's a valid JSON.",rebuildBtnTitle:"Discard manual edits and regenerate the prompt",tagBrowserSearchPlaceholder:"Search...",addSelectedBtn:"Add",resetSelectionBtn:"Reset",tagBrowserLoading:"Loading library...",tagBrowserError:"Error loading library. Ensure files are in the /data folder.",historyHeader:"Generation History",historyPlaceholder:"Your prompt history will appear here."}},o={isManualEditMode:!1,isManualLoaded:!1,savedPresets:{},currentLang:"ru",history:[],historyIndex:-1,generationHistory:[],isUndoing:!1,activeModal:null,lastFocusedElement:null,tagLibraryCache:new Map,tagBrowserState:{isOpen:!1,targetId:null,library:null,selectedTags:new Set}};function f(e,t){let a;return(...s)=>{clearTimeout(a),a=setTimeout(()=>e(...s),t)}}const d={splitTags:e=>e.split(",").map(t=>t.trim()).filter(Boolean),getUniqueTags:e=>[...new Set(e)],autoResizeTextarea:e=>{!e||!e.style||!e.scrollHeight||requestAnimationFrame(()=>{e.style.height="auto",e.style.height=`${e.scrollHeight}px`})},copyText:async(e,t)=>{if(!(!e||!t))try{navigator.clipboard&&window.isSecureContext?await navigator.clipboard.writeText(e.value):(e.select(),document.execCommand("copy"));const a=t.textContent;t.textContent=u[o.currentLang].copiedAlert,t.disabled=!0,setTimeout(()=>{t.textContent=a,t.disabled=!1},1500)}catch(a){console.error("Failed to copy:",a)}},isLocalStorageAvailable:()=>{try{const e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch{return!1}}},n={openModal:e=>{o.lastFocusedElement=document.activeElement,e.setAttribute("aria-hidden","false"),o.activeModal=e;const t=e.querySelector(".modal-close-btn");t&&setTimeout(()=>t.focus(),100)},closeModal:()=>{o.activeModal&&(o.activeModal.setAttribute("aria-hidden","true"),o.activeModal=null,o.lastFocusedElement&&o.lastFocusedElement.focus())},generatePositiveOutput:()=>{if(o.isManualEditMode)return;let e=[];r.promptParts.forEach(s=>{e=e.concat(d.splitTags(s.value))});const t=[...p.POSITIVE_QUALITY_TAGS,...e],a=d.getUniqueTags(t).join(", ");r.positiveOutput.value=a,d.autoResizeTextarea(r.positiveOutput),a.trim()&&a!==o.generationHistory[0]&&(o.generationHistory.unshift(a),o.generationHistory.length>30&&o.generationHistory.pop(),n.renderHistory())},renderHistory:()=>{if(!r.historyList)return;if(o.generationHistory.length===0){r.historyList.innerHTML='<p class="placeholder" data-i18n="historyPlaceholder">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤.</p>';return}const e=o.generationHistory.map((t,a)=>{const s=t.length>70?t.substring(0,70)+"...":t;return`<div class="history-item" data-index="${a}" title="${t}">${s}</div>`}).join("");r.historyList.innerHTML=e},updateNegativeOutput:()=>{let e=d.splitTags(r.negativeOutput.value);e=e.filter(a=>!p.NEGATIVE_QUALITY_TAGS.includes(a));const t=[...p.NEGATIVE_QUALITY_TAGS,...e];r.negativeOutput.value=d.getUniqueTags(t).join(", "),d.autoResizeTextarea(r.negativeOutput)},resetToDefaultState:()=>{n.setManualEditMode(!1),r.form.reset(),r.negativeOutput.value=p.DEFAULT_NEGATIVE_PROMPT,n.generatePositiveOutput(),n.updateNegativeOutput(),r.allTextareas.forEach(d.autoResizeTextarea),r.presetSelect.value="",n.renderPresetPreview(),n.captureState()},captureState:()=>{if(o.isUndoing)return;const e={};r.savableFields.forEach(t=>{e[t.id]=t.value}),o.historyIndex<o.history.length-1&&(o.history=o.history.slice(0,o.historyIndex+1)),o.history.push(e),o.historyIndex=o.history.length-1,o.history.length>50&&(o.history.shift(),o.historyIndex--)},restoreState:e=>{o.isUndoing=!0;for(const[t,a]of Object.entries(e)){const s=document.getElementById(t);s&&(s.value=a)}r.allTextareas.forEach(d.autoResizeTextarea),n.generatePositiveOutput(),n.updateNegativeOutput(),setTimeout(()=>{o.isUndoing=!1},0)},undo:()=>{o.historyIndex>0&&(o.historyIndex--,n.restoreState(o.history[o.historyIndex]))},redo:()=>{o.historyIndex<o.history.length-1&&(o.historyIndex++,n.restoreState(o.history[o.historyIndex]))},setManualEditMode:e=>{o.isManualEditMode=e,r.positiveOutput.classList.toggle("manual-edit",e)},handleWeightControl:e=>{const t=e.target.closest(".weight-btn");if(!t)return;e.preventDefault();const a=t.closest(".input-group").querySelector("textarea");if(!a)return;const{selectionStart:s,selectionEnd:c}=a,l=t.dataset.action;let i,h;if(s!==c)h=s,i=a.value.substring(s,c);else{const E=a.value.substring(0,c).lastIndexOf(",");h=E===-1?0:E+1,i=a.value.substring(h,c)}if(!i.trim())return;const m=/^\s*\((.+?):([\d.]+)\)\s*$/,g=i.trim().match(m),v=g?g[1].trim():i.trim(),T=g?parseFloat(g[2]):1;let y=parseFloat((l==="increase"?T+.1:T-.1).toFixed(1));y=Math.max(0,y);const B=y===1?v:`(${v}:${y})`,w=a.value.indexOf(i,h),S=w+i.length;a.setRangeText(B,w,S,"select"),a.focus(),n.generatePositiveOutput(),n.captureState()},handleSavePreset:()=>{const e=r.presetNameInput.value.trim();if(!e){alert(u[o.currentLang].presetNamePlaceholder);return}const t={};r.savableFields.forEach(a=>{t[a.id]=a.value}),o.savedPresets[e]=t,n.populatePresetDropdown(),r.presetSelect.value=e,n.renderPresetPreview(),r.presetNameInput.value=""},handleLoadPreset:()=>{const e=r.presetSelect.value;if(!e||!o.savedPresets[e]){n.resetToDefaultState();return}const t=o.savedPresets[e];r.savableFields.forEach(a=>{a.value=t[a.id]||(a.id==="output-negative"?p.DEFAULT_NEGATIVE_PROMPT:"")}),r.allTextareas.forEach(d.autoResizeTextarea),n.setManualEditMode(!1),n.generatePositiveOutput(),n.updateNegativeOutput(),n.captureState()},handleDeletePreset:()=>{const e=r.presetSelect.value;!e||!o.savedPresets[e]||confirm(`Delete preset "${e}" from this session?`)&&(delete o.savedPresets[e],n.populatePresetDropdown())},populatePresetDropdown:()=>{const e=u[o.currentLang].presetSelectDefault;r.presetSelect.innerHTML=`<option value="">${e}</option>`,Object.keys(o.savedPresets).sort().forEach(t=>{const a=document.createElement("option");a.value=t,a.textContent=t,r.presetSelect.appendChild(a)}),n.renderPresetPreview()},renderPresetPreview:()=>{var s,c;const e=r.presetSelect.value,t=o.savedPresets[e];if(!e||!t){r.presetPreview.dataset.hidden="true",r.presetPreview.innerHTML="";return}r.presetPreview.dataset.hidden="false",r.presetPreview.innerHTML="";const a=document.createDocumentFragment();for(const[l,i]of Object.entries(t))if(i.trim()){const h=(c=(s=document.querySelector(`#${l}`))==null?void 0:s.closest(".prompt-card"))==null?void 0:c.querySelector("[data-i18n]"),m=h?h.textContent.replace(/üé®|üë§|üèûÔ∏è|üîû/g,"").trim():l,g=document.createElement("li");g.innerHTML=`<strong>${m}:</strong> `,g.appendChild(document.createTextNode(i)),a.appendChild(g)}r.presetPreview.appendChild(a)},handleExportPresets:()=>{if(Object.keys(o.savedPresets).length===0){alert(u[o.currentLang].alertNoPresets);return}const e=JSON.stringify(o.savedPresets,null,2),t=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(t),s=document.createElement("a");s.href=a,s.download="prompt-artisan-presets.json",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)},handleImportPresets:()=>{const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=t=>{const a=t.target.files[0];if(!a)return;const s=new FileReader;s.onload=c=>{try{const l=JSON.parse(c.target.result);if(typeof l=="object"&&l!==null)o.savedPresets=l,n.populatePresetDropdown();else throw new Error("Invalid JSON structure")}catch(l){alert(u[o.currentLang].alertImportError),console.error("Import error:",l)}},s.readAsText(a)},e.click()},showManual:async()=>{if(n.openModal(r.manualModal),o.isManualLoaded)return;r.manualBody.innerHTML='<div class="spinner"></div>';const e=o.currentLang==="ru"?"assets/manual-content.html":"assets/manual-content-en.html";try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const a=await t.text();r.manualBody.innerHTML=a,o.isManualLoaded=!0}catch(t){console.error("Failed to load manual:",t),r.manualBody.innerHTML=u[o.currentLang].alertImportError}},setLanguage:e=>{o.currentLang=e,d.isLocalStorageAvailable()&&localStorage.setItem(p.LANG_KEY,e),document.documentElement.lang=e,r.langToggleCheckbox.checked=e==="en";const t=u[e];document.querySelectorAll("[data-i18n]").forEach(s=>{t[s.dataset.i18n]&&(s.textContent=t[s.dataset.i18n])}),document.querySelectorAll("[data-i18n-placeholder]").forEach(s=>{t[s.dataset.i18nPlaceholder]&&(s.placeholder=t[s.dataset.i18nPlaceholder])}),document.querySelectorAll("[data-i18n-title]").forEach(s=>{t[s.dataset.i18nTitle]&&(s.title=t[s.dataset.i18nTitle])});const a=document.querySelector('footer span[data-i18n="footerText"]');a&&(a.textContent=`${t.footerText} | v${p.APP_VERSION}`),n.populatePresetDropdown(),o.isManualLoaded=!1},setTheme:e=>{document.body.dataset.theme=e,d.isLocalStorageAvailable()&&localStorage.setItem(p.THEME_KEY,e),r.themeToggleCheckbox.checked=e==="light"},toggleTheme:()=>{n.setTheme(r.themeToggleCheckbox.checked?"light":"dark")},openTagBrowser:async(e,t)=>{if(o.tagBrowserState.targetId!==e&&o.tagBrowserState.selectedTags.clear(),o.tagBrowserState.isOpen=!0,o.tagBrowserState.targetId=e,r.tagBrowserSearch.value="",n.openModal(r.tagBrowserModal),r.tagBrowserSubcategories.innerHTML='<div class="spinner"></div>',r.tagBrowserTitle.textContent=u[o.currentLang].tagBrowserLoading,o.tagLibraryCache.has(t)){o.tagBrowserState.library=o.tagLibraryCache.get(t),n.renderTagBrowser();return}try{const a=await fetch(`data/${t}`);if(!a.ok)throw new Error(`Network response was not ok: ${a.statusText}`);const s=await a.json();o.tagLibraryCache.set(t,s),o.tagBrowserState.library=s,n.renderTagBrowser()}catch(a){console.error("Failed to load tag library:",a),r.tagBrowserSubcategories.innerHTML=`<p style="text-align: center; padding: 20px;">${u[o.currentLang].tagBrowserError}</p>`}},handleResetSelection:()=>{o.tagBrowserState.selectedTags.clear(),n.updateTagBrowserFooter(),r.tagBrowserSubcategories.querySelectorAll(".tag-item-new.selected").forEach(e=>{e.classList.remove("selected")})},renderTagBrowser:()=>{const{library:e}=o.tagBrowserState;if(!e)return;const t=o.currentLang;r.tagBrowserTitle.textContent=e[`name_${t}`]||e.name_ru,r.tagBrowserSearch.placeholder=u[t].tagBrowserSearchPlaceholder,r.tagBrowserSubcategories.innerHTML="";const a=document.createElement("div");a.className="subcategory-accordion",e.subcategories.forEach(s=>{const c=document.createElement("details");c.innerHTML=`
                <summary>
                    <span class="category-name">
                        <span>${s[`name_${t}`]||s.name_ru}</span>
                        <span class="tag-count">(${s.tags.length})</span>
                    </span>
                </summary>
                <div class="tag-browser-tags-list-new" data-subcat-id="${s.id}"></div>
            `,a.appendChild(c),c.addEventListener("toggle",()=>{const l=c.querySelector(".tag-browser-tags-list-new");c.open&&!l.hasChildNodes()&&n.renderTagsForSubcategory(s,l)})}),r.tagBrowserSubcategories.appendChild(a),n.updateTagBrowserFooter()},renderTagsForSubcategory:(e,t)=>{const{selectedTags:a}=o.tagBrowserState,s=o.currentLang,c=document.createDocumentFragment();e.tags.forEach(l=>{const i=document.createElement("div");i.className="tag-item-new",i.dataset.tag=l.tag,e.id.includes("_nsfw")&&i.classList.add("nsfw"),a.has(l.tag)&&i.classList.add("selected");const h=[l[`name_${s}`]||l.name_ru,l.tag,l[`desc_${s}`]||""].join(" ").toLowerCase();i.dataset.search=h;const m=(l[`desc_${s}`]||"").trim()?`<div class="tag-desc">${l[`desc_${s}`]}</div>`:"";i.innerHTML=`
                <div class="tag-info">
                    <span class="tag-name">${l[`name_${s}`]||l.name_ru}</span>
                    <span class="tag-code">${l.tag}</span>
                    ${m}
                </div>
                <button type="button" class="quick-add-btn" title="Quick add '${l.tag}'" aria-label="Quick add '${l.tag}'">&#43;</button>
            `,i.addEventListener("click",()=>n.handleTagClick(l.tag,i)),i.querySelector(".quick-add-btn").addEventListener("click",g=>{g.stopPropagation(),n.handleQuickAdd(l.tag)}),c.appendChild(i)}),t.innerHTML="",t.appendChild(c)},handleTagClick:(e,t)=>{const{selectedTags:a}=o.tagBrowserState;a.has(e)?a.delete(e):a.add(e),t.classList.toggle("selected"),n.updateTagBrowserFooter()},handleQuickAdd:e=>{const{targetId:t}=o.tagBrowserState,a=document.getElementById(t);if(!a)return;const s=new Set(d.splitTags(a.value));s.add(e),a.value=Array.from(s).join(", "),d.autoResizeTextarea(a),n.generatePositiveOutput(),n.captureState(),n.closeModal()},updateTagBrowserFooter:()=>{const{selectedTags:e}=o.tagBrowserState;r.addSelectedTagsBtn.disabled=e.size===0,r.addSelectedTagsBtn.textContent=`${u[o.currentLang].addSelectedBtn} (${e.size})`,r.tagBrowserSelectionPreview.textContent=Array.from(e).join(", ")},addSelectedTagsToTextarea:()=>{const{targetId:e,selectedTags:t}=o.tagBrowserState,a=document.getElementById(e);if(!a)return;const s=new Set(d.splitTags(a.value));t.forEach(c=>s.add(c)),a.value=Array.from(s).join(", "),d.autoResizeTextarea(a),n.generatePositiveOutput(),n.captureState(),t.clear(),n.closeModal()},filterTagsBySearch:()=>{const e=r.tagBrowserSearch.value.toLowerCase();r.tagBrowserSubcategories.querySelectorAll(".tag-item-new").forEach(t=>{const a=t.dataset.search.includes(e);t.style.display=a?"flex":"none"})}};function b(){const e=f(n.generatePositiveOutput,300),t=f(n.captureState,1500),a=f(d.autoResizeTextarea,150);r.promptParts.forEach(i=>{i.addEventListener("input",()=>{e(),t()})}),r.negativeOutput.addEventListener("input",t),r.allTextareas.forEach(i=>{i.addEventListener("input",()=>a(i))}),r.form.addEventListener("mousedown",n.handleWeightControl),document.addEventListener("keydown",i=>{i.key==="Escape"&&n.closeModal(),i.ctrlKey&&i.key==="z"&&(i.preventDefault(),n.undo()),i.ctrlKey&&(i.key==="y"||i.shiftKey&&i.key.toLowerCase()==="z")&&(i.preventDefault(),n.redo())}),r.positiveOutput.addEventListener("input",()=>n.setManualEditMode(!0)),r.rebuildBtn.addEventListener("click",()=>{n.setManualEditMode(!1),n.generatePositiveOutput(),n.captureState()}),r.clearFormBtn.addEventListener("click",n.resetToDefaultState),r.themeToggleCheckbox.addEventListener("change",n.toggleTheme),r.langToggleCheckbox.addEventListener("change",()=>n.setLanguage(r.langToggleCheckbox.checked?"en":"ru")),r.importPresetsBtn.addEventListener("click",n.handleImportPresets),r.exportPresetsBtn.addEventListener("click",n.handleExportPresets),r.copyPositiveBtn.addEventListener("click",i=>d.copyText(r.positiveOutput,i.target)),r.copyNegativeBtn.addEventListener("click",i=>d.copyText(r.negativeOutput,i.target)),r.savePresetBtn.addEventListener("click",n.handleSavePreset),r.presetSelect.addEventListener("change",()=>{n.handleLoadPreset(),n.renderPresetPreview()}),r.deletePresetBtn.addEventListener("click",n.handleDeletePreset),r.showManualBtn.addEventListener("click",n.showManual),r.closeManualBtn.addEventListener("click",n.closeModal),r.manualModal.addEventListener("click",i=>{i.target===r.manualModal&&n.closeModal()}),document.querySelectorAll(".tag-browser-btn").forEach(i=>{i.addEventListener("click",()=>n.openTagBrowser(i.dataset.targetId,i.dataset.library))}),r.closeTagBrowserBtn.addEventListener("click",n.closeModal),r.tagBrowserModal.addEventListener("click",i=>{i.target===r.tagBrowserModal&&n.closeModal()}),r.resetSelectedTagsBtn.addEventListener("click",n.handleResetSelection),r.tagBrowserSearch.addEventListener("input",f(n.filterTagsBySearch,200)),r.addSelectedTagsBtn.addEventListener("click",n.addSelectedTagsToTextarea);const s=d.isLocalStorageAvailable()?localStorage.getItem(p.LANG_KEY):"ru";n.setLanguage(s||"ru");const c=d.isLocalStorageAvailable()?localStorage.getItem(p.THEME_KEY):null,l=window.matchMedia("(prefers-color-scheme: dark)").matches;n.setTheme(c||(l?"dark":"light")),n.captureState(),setTimeout(n.resetToDefaultState,0)}document.addEventListener("DOMContentLoaded",b);
